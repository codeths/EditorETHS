<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHS Decision Tree Builder - Interactive Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .header {
            background: #2d2d30;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hamburger-btn {
            background: #37373d;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
        }

        .hamburger-btn:hover {
            background: #4e4e52;
            color: #fff;
        }

        .header h1 {
            font-size: 18px;
            color: #fff;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Hamburger Menu */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .menu-overlay.show {
            display: block;
        }

        .hamburger-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: #252526;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            transition: left 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .hamburger-menu.open {
            left: 0;
        }

        .menu-header {
            background: #2d2d30;
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-header h2 {
            color: #fff;
            font-size: 18px;
            margin: 0;
        }

        .close-menu-btn {
            background: none;
            border: none;
            color: #969696;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .close-menu-btn:hover {
            color: #fff;
        }

        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .menu-btn {
            width: 100%;
            background: #37373d;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-size: 14px;
            text-align: left;
        }

        .menu-btn:hover {
            background: #4e4e52;
            color: #fff;
        }

        .menu-icon {
            font-size: 18px;
        }

        .menu-divider {
            height: 1px;
            background: #3e3e42;
            margin: 15px 0;
        }

        .menu-section-title {
            color: #969696;
            font-size: 12px;
            text-transform: uppercase;
            padding: 10px 10px 5px;
            font-weight: bold;
        }

        .project-list {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        .project-item {
            background: #37373d;
            border: 1px solid #3e3e42;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item:hover {
            background: #4e4e52;
            border-color: #0e639c;
        }

        .project-item.active {
            background: #094771;
            border-color: #0e639c;
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            color: #d4d4d4;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .project-date {
            color: #969696;
            font-size: 11px;
        }

        .project-actions {
            display: flex;
            gap: 8px;
        }

        .project-delete-btn {
            background: none;
            border: none;
            color: #969696;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: color 0.2s;
        }

        .project-delete-btn:hover {
            color: #f48771;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #252526;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            background: #2d2d30;
            padding: 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            color: #fff;
            font-size: 18px;
            margin: 0;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: #969696;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .close-modal-btn:hover {
            color: #fff;
        }

        .modal-content {
            padding: 25px;
        }

        .modal-content label {
            display: block;
            color: #d4d4d4;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            outline: none;
            border-color: #0e639c;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .cancel-btn {
            background: #37373d;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .cancel-btn:hover {
            background: #4e4e52;
        }

        .create-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .create-btn:hover {
            background: #1177bb;
        }

        .header-btn {
            background: #37373d;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: #4e4e52;
            color: #fff;
        }

        .run-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .run-btn:hover {
            background: #1177bb;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2d2d30;
            color: #4ec9b0;
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #3e3e42;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }

        /* Collaboration Styles */
        .room-code-display {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #2d2d30;
            border: 2px solid #4ec9b0;
            border-radius: 8px;
            padding: 12px 16px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .room-code-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .room-code-label {
            color: #969696;
            font-size: 12px;
            font-weight: bold;
        }

        .room-code-text {
            color: #4ec9b0;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        .copy-code-btn {
            background: #37373d;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .copy-code-btn:hover {
            background: #4e4e52;
            color: #fff;
        }

        .close-room-code-btn {
            background: transparent;
            border: none;
            color: #969696;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .close-room-code-btn:hover {
            color: #ff6b6b;
        }

        .collab-panel {
            position: fixed;
            top: 130px;
            right: 20px;
            width: 250px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            z-index: 999;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-height: 400px;
            overflow: hidden;
        }

        .collab-header {
            background: #37373d;
            padding: 12px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collab-header h3 {
            margin: 0;
            font-size: 14px;
            color: #fff;
        }

        .collab-status {
            font-size: 11px;
            color: #4ec9b0;
        }

        .participants-list {
            padding: 10px;
            max-height: 340px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #37373d;
            border-radius: 5px;
            border: 1px solid #3e3e42;
        }

        .participant-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .participant-name {
            color: #d4d4d4;
            font-size: 13px;
            flex: 1;
        }

        .participant-you {
            color: #4ec9b0;
            font-size: 11px;
            font-weight: bold;
        }

        .collab-notification {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2d2d30;
            color: #d4d4d4;
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid #3e3e42;
            font-size: 13px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1001;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .collab-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .collab-notification.success {
            border-color: #4ec9b0;
            color: #4ec9b0;
        }

        .collab-notification.error {
            border-color: #f48771;
            color: #f48771;
        }

        .collab-notification.info {
            border-color: #569cd6;
            color: #569cd6;
        }

        /* Remote Cursor Indicators */
        .remote-cursor {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 998;
            pointer-events: none;
            display: none;
        }

        .remote-cursor-label {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: cursorPulse 0.3s ease-in;
        }

        @keyframes cursorPulse {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Editor wrapper for cursor positioning */
        .editor-wrapper {
            position: relative;
        }

        .container {
            display: flex;
            height: calc(100vh - 61px);
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e3e42;
            position: relative;
        }

        .tabs {
            background: #2d2d30;
            display: flex;
            border-bottom: 1px solid #3e3e42;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #969696;
            font-size: 13px;
            border-right: 1px solid #3e3e42;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #37373d;
            color: #fff;
        }

        .tab.active {
            background: #1e1e1e;
            color: #fff;
            border-bottom: 2px solid #0e639c;
        }

        .editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .code-editor {
            width: 100%;
            height: 100%;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            resize: none;
            overflow-y: auto;
        }

        .code-editor:focus {
            outline: none;
        }

        /* Error indicators */
        .error-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 10;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .error-indicator.show {
            display: block;
        }

        .error-indicator.warning {
            background: #ff9800;
        }

        .error-indicator.success {
            background: #4caf50;
        }

        .syntax-status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
            display: none;
        }

        .syntax-status.show {
            display: block;
        }

        .syntax-status.error {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        /* Emoji Autocomplete */
        .emoji-autocomplete {
            position: absolute;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .emoji-autocomplete.show {
            display: block;
        }

        .emoji-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #d4d4d4;
            font-size: 14px;
            transition: background 0.1s;
        }

        .emoji-suggestion:hover,
        .emoji-suggestion.selected {
            background: #094771;
        }

        .emoji-suggestion .emoji-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .emoji-suggestion .emoji-name {
            color: #4ec9b0;
            font-family: monospace;
        }

        .emoji-autocomplete::-webkit-scrollbar {
            width: 8px;
        }

        .emoji-autocomplete::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .emoji-autocomplete::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 4px;
        }

        .emoji-autocomplete::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        .preview-panel {
            width: 50%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            background: #f3f3f3;
            padding: 12px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            font-weight: bold;
            color: #333;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .preview-btn {
            background: #e0e0e0;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.2s;
        }

        .preview-btn:hover {
            background: #d0d0d0;
            color: #333;
        }

        .clear-console-btn {
            background: #e0e0e0;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
        }

        .clear-console-btn:hover {
            background: #d0d0d0;
        }

        /* Fullscreen mode styles */
        .preview-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 10000;
            background: white;
        }

        .preview-panel.fullscreen .preview-content {
            height: calc(100vh - 48px);
        }

        .preview-panel.fullscreen .preview-btn.fullscreen-active {
            background: #007acc;
            color: white;
        }

        .preview-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        iframe {
            width: 100%;
            flex: 1;
            border: none;
        }

        .console-panel {
            height: 150px;
            background: #1e1e1e;
            border-top: 1px solid #3e3e42;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            padding: 10px;
            color: #d4d4d4;
        }

        .console-entry {
            padding: 4px 0;
            border-bottom: 1px solid #2d2d30;
        }

        .console-log {
            color: #d4d4d4;
        }

        .console-error {
            color: #f48771;
        }

        .console-warn {
            color: #dcdcaa;
        }

        .console-info {
            color: #4ec9b0;
        }

        /* Syntax highlighting colors */
        .code-editor::selection {
            background: #264f78;
        }

        /* Instructions panel */
        .instructions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2d2d30;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .instructions h3 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .instructions p {
            color: #969696;
            font-size: 12px;
            line-height: 1.5;
        }

        .close-instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #969696;
            cursor: pointer;
            font-size: 18px;
        }

        .close-instructions:hover {
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .editor-panel, .preview-panel {
                width: 100%;
                height: 50%;
            }

            .instructions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="hamburger-btn" onclick="toggleMenu()">‚ò∞</button>
            <h1 id="project-title">üéì ETHS Decision Tree Builder</h1>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="collab-btn" onclick="showCollabMenu()" title="Collaborate with others in real-time">
                üë• Collaborate
            </button>
            <button class="header-btn" onclick="importCode()" title="Import your saved HTML file">
                üì• Import
            </button>
            <button class="header-btn" onclick="exportCode()" title="Download as single HTML file">
                üíæ Export
            </button>
            <button class="header-btn" onclick="resetCode()" title="Reset to original starter code">
                üîÑ Reset
            </button>
            <button class="run-btn" onclick="runCode()">‚ñ∂ Run Code</button>
        </div>
    </div>

    <!-- Hamburger Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    
    <!-- Hamburger Menu -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="menu-header">
            <h2>Projects</h2>
            <button class="close-menu-btn" onclick="closeMenu()">√ó</button>
        </div>
        
        <div class="menu-content">
            <button class="menu-btn" onclick="createNewProject()">
                <span class="menu-icon">‚ûï</span>
                <span>New Project</span>
            </button>
            
            <button class="menu-btn" onclick="importProject()">
                <span class="menu-icon">üìÅ</span>
                <span>Open from Device</span>
            </button>
            
            <div class="menu-divider"></div>
            
            <div class="menu-section-title">Recent Projects</div>
            <div id="projectList" class="project-list">
                <!-- Projects will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Create New Project</h2>
                <button class="close-modal-btn" onclick="closeNewProjectModal()">√ó</button>
            </div>
            <div class="modal-content">
                <label for="projectName">Project Name:</label>
                <input type="text" id="projectName" placeholder="My Awesome Decision Tree" />
                
                <label for="projectTemplate">Template:</label>
                <select id="projectTemplate">
                    <option value="decision-tree">ETHS Decision Tree (Default)</option>
                    <option value="blank">Blank Project</option>
                    <option value="simple-page">Simple Webpage</option>
                </select>
                
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="closeNewProjectModal()">Cancel</button>
                    <button class="create-btn" onclick="confirmNewProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="fileInput" accept=".html,.css,.js" multiple style="display: none;" onchange="handleFileUpload(event)">

    <div class="container">
        <!-- Left Panel: Code Editor -->
        <div class="editor-panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('html')">HTML</button>
                <button class="tab" onclick="switchTab('css')">CSS</button>
                <button class="tab" onclick="switchTab('js')">JavaScript</button>
            </div>
            <div class="editor-content">
                <div id="html-error" class="error-indicator"></div>
                <div id="html-status" class="syntax-status"></div>
                <div id="html-emoji-autocomplete" class="emoji-autocomplete"></div>
                <textarea id="html-editor" class="code-editor" spellcheck="false"></textarea>
                
                <div id="css-error" class="error-indicator"></div>
                <div id="css-status" class="syntax-status"></div>
                <div id="css-emoji-autocomplete" class="emoji-autocomplete"></div>
                <textarea id="css-editor" class="code-editor" style="display:none;" spellcheck="false"></textarea>
                
                <div id="js-error" class="error-indicator"></div>
                <div id="js-status" class="syntax-status"></div>
                <div id="js-emoji-autocomplete" class="emoji-autocomplete"></div>
                <textarea id="js-editor" class="code-editor" style="display:none;" spellcheck="false"></textarea>
            </div>
        </div>

        <!-- Right Panel: Live Preview -->
        <div class="preview-panel" id="previewPanel">
            <div class="preview-header">
                <span class="preview-title">Live Preview</span>
                <div class="preview-controls">
                    <button class="preview-btn" onclick="openPreviewInNewWindow()" title="Open preview in new window">
                        üóó New Window
                    </button>
                    <button class="preview-btn" onclick="toggleFullscreen()" title="Toggle fullscreen preview">
                        ‚õ∂ Fullscreen
                    </button>
                    <button class="clear-console-btn" onclick="clearConsole()">Clear Console</button>
                </div>
            </div>
            <div class="preview-content">
                <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
                <div class="console-panel" id="console">
                    <div class="console-entry console-info">Console ready. Use console.log() to see output here!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        ‚úì Auto-saved
    </div>

    <!-- Collaboration Room Code Display -->
    <div id="room-code-display" class="room-code-display">
        <div class="room-code-content">
            <span class="room-code-label">Room Code:</span>
            <span class="room-code-text" id="room-code-text">------</span>
            <button class="copy-code-btn" onclick="copyRoomCode()" title="Copy room code">üìã</button>
            <button class="close-room-code-btn" onclick="hideRoomCode()" title="Hide room code">‚úï</button>
        </div>
    </div>

    <!-- Collaboration Panel -->
    <div id="collab-panel" class="collab-panel">
        <div class="collab-header">
            <h3>üë• Participants</h3>
            <span class="collab-status" id="collab-status">Connected</span>
        </div>
        <div id="participants-list" class="participants-list">
            <!-- Participants will be added here dynamically -->
        </div>
    </div>

    <!-- Collaboration Notification -->
    <div id="collab-notification" class="collab-notification"></div>

    <!-- Instructions -->
    <div class="instructions" id="instructions">
        <button class="close-instructions" onclick="closeInstructions()">√ó</button>
        <h3>üéì Quick Start Guide</h3>
        <p>
            1. Switch between HTML, CSS, and JavaScript tabs<br>
            2. Edit the code<br>
            3. Click "Run Code" to see changes<br>
            4. Try adding your own questions!
        </p>
        <h3>‚ú® Smart Autocomplete</h3>
        <p style="font-size: 13px; margin-top: 10px;">
            <strong>HTML:</strong> Type <code>&lt;!DOCTYPE html&gt;</code> for full boilerplate<br>
            <strong>Tags:</strong> <code>&lt;div&gt;</code>, <code>&lt;img&gt;</code>, <code>&lt;a&gt;</code> auto-complete<br>
            <strong>CSS:</strong> <code>@media</code>, <code>flexbox</code>, <code>grid</code> shortcuts<br>
            <strong>JS:</strong> <code>function()</code>, <code>class</code>, <code>fetch</code> templates
        </p>
        <h3>üòé Emoji Shortcuts</h3>
        <p style="font-size: 13px; margin-top: 10px;">
            Type <code>:emoji_name:</code> to insert emojis!<br>
            Examples: <code>:fire:</code> üî• | <code>:heart:</code> ‚ù§Ô∏è | <code>:rocket:</code> üöÄ | <code>:thumbsup:</code> üëç
        </p>
    </div>

    <script>
        // ============================================
        // INITIAL CODE TEMPLATES
        // ============================================
        // These are the starting templates that students begin with
        
        const initialHTML = `<!-- 
=========================================
ETHS DECISION TREE - HTML STRUCTURE
=========================================
This is the skeleton of your page.
Think of HTML as the bones - it defines WHAT goes on the page.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHS Elective Chooser</title>
</head>
<body>
    <!-- This div will hold all our questions and results -->
    <div class="container">
        <div id="content">
            <!-- JavaScript will put content here -->
        </div>
    </div>
</body>
</html>`;

        const initialCSS = `/* 
=========================================
ETHS DECISION TREE - STYLING (CSS)
=========================================
This is the "makeup" - it defines HOW things look.
Change colors, sizes, spacing, etc. here!
*/

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    background: white;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
}

.container {
    background: white;
    padding: 40px;
    max-width: 900px;
    width: 100%;
}

.question-box {
    text-align: center;
}

h1 {
    color: black;
    margin-bottom: 40px;
    font-size: 20px;
    font-weight: normal;
}

/* The pink rounded box for questions */
.question {
    font-size: 16px;
    color: black;
    margin-bottom: 40px;
    line-height: 1.5;
    background: #FFB6C1;  /* Pink color - try changing this! */
    padding: 25px 40px;
    border-radius: 50px;
    display: inline-block;
    min-width: 300px;
}

.options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
}

/* The blue rounded buttons for answer choices */
.option-btn {
    background: #B0C4DE;  /* Light blue - try changing this! */
    color: black;
    border: none;
    padding: 20px 40px;
    font-size: 15px;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 280px;
    text-align: center;
}

.option-btn:hover {
    background: #9FB3D0;  /* Darker blue on hover */
    transform: scale(1.05);  /* Slightly bigger on hover */
}

.back-btn {
    background: #D9D9D9;  /* Gray */
    color: black;
    border: none;
    padding: 12px 30px;
    font-size: 14px;
    border-radius: 25px;
    cursor: pointer;
    margin-top: 30px;
    transition: all 0.2s ease;
}

.back-btn:hover {
    background: #C0C0C0;
}

.result-box {
    text-align: center;
    padding: 20px;
}

.result-title {
    color: black;
    font-size: 18px;
    margin-bottom: 25px;
    font-weight: bold;
    background: #B0C4DE;
    padding: 25px 40px;
    border-radius: 50px;
    display: inline-block;
}

.result-description {
    color: black;
    font-size: 15px;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto 30px;
}

.restart-btn {
    background: #FFB6C1;
    color: black;
    border: none;
    padding: 15px 40px;
    font-size: 15px;
    border-radius: 25px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s ease;
}

.restart-btn:hover {
    background: #FFA0B0;
}

.breadcrumb {
    color: #666;
    font-size: 13px;
    margin-bottom: 20px;
    text-align: center;
}`;

        const initialJS = `/* 
=========================================
ETHS DECISION TREE - JAVASCRIPT (THE BRAIN)
=========================================
This makes your page INTERACTIVE!
JavaScript controls what happens when you click buttons.
*/

// ============================================
// PART 1: THE DECISION TREE (Your Questions & Results)
// ============================================
// This object is like a Choose-Your-Own-Adventure book.
// Each "node" is a page in the book.

const decisionTree = {
    // The first question (starting point)
    start: {
        type: "question",
        question: "What type of ETHS elective are you interested in?",
        options: [
            { text: "Arts & Creativity", next: "arts_type" },
            { text: "Career & Technical", next: "cte_type" },
            { text: "I want to explore!", next: "result_explore" }
        ]
    },

    // Second level: Arts
    arts_type: {
        type: "question",
        question: "Which area of arts interests you?",
        options: [
            { text: "Visual Arts (Drawing, Painting)", next: "result_visual" },
            { text: "Music (Band, Orchestra, Choir)", next: "result_music" },
            { text: "Theatre & Performance", next: "result_theatre" }
        ]
    },

    // Second level: CTE
    cte_type: {
        type: "question",
        question: "Which career path interests you?",
        options: [
            { text: "Computer Science & Tech", next: "result_cs" },
            { text: "Engineering (PLTW)", next: "result_engineering" },
            { text: "Business & Entrepreneurship", next: "result_business" }
        ]
    },

    // RESULTS (Final recommendations)
    result_visual: {
        type: "result",
        title: "Visual Arts",
        description: "Take Drawing & Painting, Ceramics, or Digital Photography to explore your creativity!"
    },

    result_music: {
        type: "result",
        title: "Music Program",
        description: "Join Band, Orchestra, or Choir! ETHS music groups perform at regional and national venues."
    },

    result_theatre: {
        type: "result",
        title: "Theatre & Performance",
        description: "Try Theatre 1-3 or audition for ETHS productions including the famous YAMO sketch comedy show!"
    },

    result_cs: {
        type: "result",
        title: "Computer Science",
        description: "Study programming, web design, and app development. Build real projects!"
    },

    result_engineering: {
        type: "result",
        title: "Engineering (PLTW)",
        description: "Project Lead The Way courses give you hands-on engineering experience. Plus you get a 1.0 GPA boost!"
    },

    result_business: {
        type: "result",
        title: "Business Education",
        description: "Learn accounting, marketing, and entrepreneurship. Start your own business!"
    },

    result_explore: {
        type: "result",
        title: "Explore Everything!",
        description: "Talk to your counselor about sampling different electives each semester. ETHS has 100+ options!"
    }
};

// ============================================
// PART 2: TRACKING WHERE WE ARE
// ============================================
// These variables remember your current position

let currentNode = "start";  // Where you are now (starts at first question)
let history = [];            // Where you've been (for the back button)

// ============================================
// PART 3: THE MAIN FUNCTION - RENDER
// ============================================
// This decides what to show on screen

function render() {
    // Look up the current node in our tree
    const node = decisionTree[currentNode];
    
    // Is it a question or a result?
    if (node.type === "question") {
        renderQuestion(node);
    } else if (node.type === "result") {
        renderResult(node);
    }
}

// ============================================
// PART 4: SHOWING A QUESTION
// ============================================
function renderQuestion(node) {
    const content = document.getElementById("content");
    
    // Build the breadcrumb
    let breadcrumb = "";
    if (history.length > 0) {
        breadcrumb = \`<div class="breadcrumb">Step \${history.length + 1}</div>\`;
    }

    // Start building the HTML
    let html = \`
        \${breadcrumb}
        <div class="question-box">
            <h1>ETHS Elective Chooser</h1>
            <div class="question">\${node.question}</div>
            <div class="options">
    \`;

    // Add a button for each option
    node.options.forEach((option) => {
        html += \`
            <button class="option-btn" onclick="selectOption('\${option.next}')">
                \${option.text}
            </button>
        \`;
    });

    html += \`</div>\`;

    // Add back button if not on first question
    if (history.length > 0) {
        html += \`<button class="back-btn" onclick="goBack()">‚Üê Back</button>\`;
    }

    html += \`</div>\`;

    // Put the HTML on the page
    content.innerHTML = html;
}

// ============================================
// PART 5: SHOWING A RESULT
// ============================================
function renderResult(node) {
    const content = document.getElementById("content");
    
    const html = \`
        <div class="result-box">
            <div class="breadcrumb">Final Result</div>
            <h1 class="result-title">\${node.title}</h1>
            <div class="result-description">\${node.description}</div>
            <button class="restart-btn" onclick="restart()">Start Over</button>
            <button class="back-btn" onclick="goBack()">‚Üê Back</button>
        </div>
    \`;

    content.innerHTML = html;
}

// ============================================
// PART 6: USER INTERACTIONS
// ============================================

// When user clicks an option button
function selectOption(nextNode) {
    history.push(currentNode);  // Remember where we were
    currentNode = nextNode;      // Move to new location
    render();                    // Show the new screen
}

// When user clicks Back button
function goBack() {
    if (history.length > 0) {
        currentNode = history.pop();  // Go back to previous location
        render();
    }
}

// When user clicks Start Over
function restart() {
    currentNode = "start";
    history = [];
    render();
}

// ============================================
// START THE APP!
// ============================================
// This runs when the page first loads
render();`;

        // Blank templates for new projects
        const blankHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Project</title>
</head>
<body>
    <h1>Hello World!</h1>
</body>
</html>`;

        const blankCSS = `/* Your CSS here */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
}`;

        const blankJS = `// Your JavaScript here
console.log("Hello, World!");`;

        // Simple page template
        const simpleHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Webpage</title>
</head>
<body>
    <header>
        <h1>My Awesome Webpage</h1>
        <nav>
            <a href="#about">About</a>
            <a href="#contact">Contact</a>
        </nav>
    </header>
    
    <main>
        <section id="about">
            <h2>About</h2>
            <p>Welcome to my page!</p>
        </section>
        
        <section id="contact">
            <h2>Contact</h2>
            <p>Email: student@eths.k12.il.us</p>
        </section>
    </main>
    
    <footer>
        <p>&copy; 2025 My Website</p>
    </footer>
</body>
</html>`;

        const simpleCSS = `/* Simple page styling */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
}

header {
    background: #333;
    color: white;
    padding: 20px;
    text-align: center;
}

nav {
    margin-top: 10px;
}

nav a {
    color: white;
    text-decoration: none;
    margin: 0 15px;
}

nav a:hover {
    text-decoration: underline;
}

main {
    max-width: 800px;
    margin: 40px auto;
    padding: 0 20px;
}

section {
    margin-bottom: 40px;
}

footer {
    background: #f4f4f4;
    text-align: center;
    padding: 20px;
    margin-top: 40px;
}`;

        const simpleJS = `// Add interactivity
console.log("Page loaded!");

// Smooth scrolling for nav links
document.querySelectorAll('nav a').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        target.scrollIntoView({ behavior: 'smooth' });
    });
});`;

        // ============================================
        // PROJECT MANAGEMENT
        // ============================================
        
        let currentProject = {
            id: 'default',
            name: 'üéì ETHS Decision Tree Builder',
            html: initialHTML,
            css: initialCSS,
            js: initialJS,
            lastModified: new Date().toISOString()
        };

        // Get all projects from localStorage
        function getAllProjects() {
            const projectsJson = localStorage.getItem('eths-projects');
            if (!projectsJson) {
                // Create default project if none exist
                const defaultProject = {
                    id: 'default',
                    name: 'üéì ETHS Decision Tree Builder',
                    html: initialHTML,
                    css: initialCSS,
                    js: initialJS,
                    lastModified: new Date().toISOString()
                };
                const projects = [defaultProject];
                localStorage.setItem('eths-projects', JSON.stringify(projects));
                return projects;
            }
            return JSON.parse(projectsJson);
        }

        // Save all projects to localStorage
        function saveAllProjects(projects) {
            localStorage.setItem('eths-projects', JSON.stringify(projects));
        }

        // Save current project
        function saveCurrentProject() {
            currentProject.html = document.getElementById('html-editor').value;
            currentProject.css = document.getElementById('css-editor').value;
            currentProject.js = document.getElementById('js-editor').value;
            currentProject.lastModified = new Date().toISOString();
            
            const projects = getAllProjects();
            const index = projects.findIndex(p => p.id === currentProject.id);
            
            if (index >= 0) {
                projects[index] = currentProject;
            } else {
                projects.push(currentProject);
            }
            
            saveAllProjects(projects);
            updateProjectList();
        }

        // Load a project
        function loadProject(projectId) {
            const projects = getAllProjects();
            const project = projects.find(p => p.id === projectId);
            
            if (project) {
                currentProject = project;
                document.getElementById('html-editor').value = project.html;
                document.getElementById('css-editor').value = project.css;
                document.getElementById('js-editor').value = project.js;
                document.getElementById('project-title').textContent = project.name;
                
                // Clear all error indicators when switching projects
                ['html', 'css', 'js'].forEach(t => {
                    const errorDiv = document.getElementById(`${t}-error`);
                    const statusDiv = document.getElementById(`${t}-status`);
                    errorDiv.className = 'error-indicator';
                    errorDiv.textContent = '';
                    statusDiv.className = 'syntax-status';
                    statusDiv.textContent = '';
                });
                
                runCode();
                
                // Check syntax for current tab after loading
                setTimeout(() => {
                    checkCurrentSyntax();
                }, 100);
                
                closeMenu();
            }
        }

        // Update project list in menu
        function updateProjectList() {
            const projects = getAllProjects();
            const projectList = document.getElementById('projectList');
            
            if (projects.length === 0) {
                projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #969696;">No projects yet</div>';
                return;
            }
            
            projectList.innerHTML = projects.map(project => `
                <div class="project-item ${project.id === currentProject.id ? 'active' : ''}" onclick="loadProject('${project.id}')">
                    <div class="project-info">
                        <div class="project-name">${project.name}</div>
                        <div class="project-date">${formatDate(project.lastModified)}</div>
                    </div>
                    <div class="project-actions">
                        ${project.id !== 'default' ? `<button class="project-delete-btn" onclick="event.stopPropagation(); deleteProject('${project.id}')" title="Delete project">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Delete a project
        function deleteProject(projectId) {
            if (confirm('Delete this project? This cannot be undone.')) {
                let projects = getAllProjects();
                projects = projects.filter(p => p.id !== projectId);
                saveAllProjects(projects);
                
                // If we deleted the current project, load the default one
                if (currentProject.id === projectId) {
                    loadProject('default');
                }
                
                updateProjectList();
            }
        }

        // Format date for display
        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            return date.toLocaleDateString();
        }

        // ============================================
        // EDITOR FUNCTIONALITY
        // ============================================
        
        // Set initial code in editors
        document.getElementById('html-editor').value = currentProject.html;
        document.getElementById('css-editor').value = currentProject.css;
        document.getElementById('js-editor').value = currentProject.js;

        // Current tab tracking
        let currentTab = 'html';

        // ============================================
        // MENU FUNCTIONS
        // ============================================
        
        function toggleMenu() {
            const menu = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('show');
            updateProjectList();
        }

        function closeMenu() {
            const menu = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.remove('open');
            overlay.classList.remove('show');
        }

        function createNewProject() {
            document.getElementById('newProjectModal').classList.add('show');
            document.getElementById('projectName').value = '';
            document.getElementById('projectName').focus();
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('show');
        }

        function confirmNewProject() {
            const name = document.getElementById('projectName').value.trim();
            const template = document.getElementById('projectTemplate').value;
            
            if (!name) {
                alert('Please enter a project name!');
                return;
            }
            
            // Generate unique ID
            const id = 'project-' + Date.now();
            
            // Get template code
            let html, css, js;
            if (template === 'blank') {
                html = blankHTML;
                css = blankCSS;
                js = blankJS;
            } else if (template === 'simple-page') {
                html = simpleHTML;
                css = simpleCSS;
                js = simpleJS;
            } else {
                html = initialHTML;
                css = initialCSS;
                js = initialJS;
            }
            
            // Create new project
            currentProject = {
                id: id,
                name: name,
                html: html,
                css: css,
                js: js,
                lastModified: new Date().toISOString()
            };
            
            // Save it
            saveCurrentProject();
            
            // Load it
            document.getElementById('html-editor').value = html;
            document.getElementById('css-editor').value = css;
            document.getElementById('js-editor').value = js;
            document.getElementById('project-title').textContent = name;
            
            // Close modal and menu
            closeNewProjectModal();
            closeMenu();
            
            // Run the code
            runCode();
        }

        function importProject() {
            closeMenu();
            importCode();
        }

        // ============================================
        // SYNTAX CHECKING (No APIs, All Browser-Based!)
        // ============================================
        
        // Check HTML syntax
        function checkHTMLSyntax(code) {
            const errors = [];
            const warnings = [];
            
            // Check for unclosed tags
            const openTags = [];
            const selfClosingTags = ['img', 'br', 'hr', 'input', 'meta', 'link', 'area', 'base', 'col', 'embed', 'param', 'source', 'track', 'wbr'];
            
            // Simple tag matching (not perfect but catches common errors)
            const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9]*)[^>]*>/g;
            let match;
            
            while ((match = tagRegex.exec(code)) !== null) {
                const fullTag = match[0];
                const tagName = match[1].toLowerCase();
                
                if (fullTag.startsWith('</')) {
                    // Closing tag
                    if (openTags.length === 0) {
                        errors.push(`Closing tag </${tagName}> without opening tag`);
                    } else {
                        const lastOpen = openTags.pop();
                        if (lastOpen !== tagName) {
                            errors.push(`Mismatched tags: expected </${lastOpen}> but found </${tagName}>`);
                        }
                    }
                } else if (!fullTag.endsWith('/>') && !selfClosingTags.includes(tagName)) {
                    // Opening tag (not self-closing)
                    openTags.push(tagName);
                }
            }
            
            // Check for remaining unclosed tags
            if (openTags.length > 0) {
                errors.push(`Unclosed tags: ${openTags.map(t => '<' + t + '>').join(', ')}`);
            }
            
            // Check for common issues
            if (code.includes('< /')) {
                warnings.push('Space after < in closing tag');
            }
            if (code.includes('<>')) {
                errors.push('Empty tag <>');
            }
            
            return { errors, warnings, valid: errors.length === 0 };
        }
        
        // Check CSS syntax
        function checkCSSSyntax(code) {
            const errors = [];
            const warnings = [];
            
            try {
                // Count braces
                const openBraces = (code.match(/{/g) || []).length;
                const closeBraces = (code.match(/}/g) || []).length;
                
                if (openBraces !== closeBraces) {
                    errors.push(`Mismatched braces: ${openBraces} opening { vs ${closeBraces} closing }`);
                }
                
                // Check for missing semicolons (common beginner mistake)
                const lines = code.split('\n');
                lines.forEach((line, i) => {
                    const trimmed = line.trim();
                    // Check if it's a property line (has : but not ending with ; or { or })
                    if (trimmed.includes(':') && !trimmed.endsWith(';') && !trimmed.endsWith('{') && !trimmed.endsWith('}') && !trimmed.startsWith('/*') && !trimmed.startsWith('//')) {
                        if (trimmed.length > 0 && !trimmed.includes('/*')) {
                            warnings.push(`Line ${i + 1}: Missing semicolon?`);
                        }
                    }
                });
                
                // Check for common typos
                if (code.includes('colour:')) {
                    warnings.push('British spelling detected: use "color:" not "colour:"');
                }
                
                // Try to actually parse it using the browser
                const style = document.createElement('style');
                style.textContent = code;
                document.head.appendChild(style);
                
                // Check if stylesheet loaded (basic validation)
                if (style.sheet && style.sheet.cssRules) {
                    // Successfully parsed
                }
                
                document.head.removeChild(style);
                
            } catch (e) {
                errors.push('CSS parse error: ' + e.message);
            }
            
            return { errors, warnings, valid: errors.length === 0 };
        }
        
        // Check JavaScript syntax
        function checkJSSyntax(code) {
            const errors = [];
            const warnings = [];
            
            try {
                // Use Function constructor to check syntax without executing
                new Function(code);
                
                // Additional checks for common issues
                const openParens = (code.match(/\(/g) || []).length;
                const closeParens = (code.match(/\)/g) || []).length;
                if (openParens !== closeParens) {
                    warnings.push(`Mismatched parentheses: ${openParens} ( vs ${closeParens} )`);
                }
                
                const openBrackets = (code.match(/\[/g) || []).length;
                const closeBrackets = (code.match(/\]/g) || []).length;
                if (openBrackets !== closeBrackets) {
                    warnings.push(`Mismatched brackets: ${openBrackets} [ vs ${closeBrackets} ]`);
                }
                
                const openBraces = (code.match(/{/g) || []).length;
                const closeBraces = (code.match(/}/g) || []).length;
                if (openBraces !== closeBraces) {
                    warnings.push(`Mismatched braces: ${openBraces} { vs ${closeBraces} }`);
                }
                
                // Check for console.log statements (not an error, just info)
                const consoleCount = (code.match(/console\.log/g) || []).length;
                if (consoleCount > 0) {
                    // This is fine, just noting it
                }
                
            } catch (e) {
                // Parse the error message
                let errorMsg = e.message;
                const lineMatch = errorMsg.match(/line (\d+)/);
                if (lineMatch) {
                    errors.push(`Syntax error on line ${lineMatch[1]}: ${errorMsg}`);
                } else {
                    errors.push('Syntax error: ' + errorMsg);
                }
            }
            
            return { errors, warnings, valid: errors.length === 0 };
        }
        
        // Update error display
        function updateErrorDisplay(type, result) {
            const errorDiv = document.getElementById(`${type}-error`);
            const statusDiv = document.getElementById(`${type}-status`);
            
            if (result.errors.length > 0) {
                errorDiv.textContent = '‚ùå ' + result.errors[0];
                errorDiv.className = 'error-indicator show';
                statusDiv.textContent = '‚úó Syntax error';
                statusDiv.className = 'syntax-status show error';
            } else if (result.warnings.length > 0) {
                errorDiv.textContent = '‚ö†Ô∏è ' + result.warnings[0];
                errorDiv.className = 'error-indicator show warning';
                statusDiv.textContent = '‚ö† Warning';
                statusDiv.className = 'syntax-status show error';
            } else {
                errorDiv.className = 'error-indicator';
                statusDiv.textContent = '‚úì No errors';
                statusDiv.className = 'syntax-status show';
                
                // Hide success message after 2 seconds
                setTimeout(() => {
                    statusDiv.className = 'syntax-status';
                }, 2000);
            }
        }
        
        // Check syntax for current editor
        function checkCurrentSyntax() {
            const editor = document.getElementById(`${currentTab}-editor`);
            const code = editor.value;
            let result;
            
            switch(currentTab) {
                case 'html':
                    result = checkHTMLSyntax(code);
                    break;
                case 'css':
                    result = checkCSSSyntax(code);
                    break;
                case 'js':
                    result = checkJSSyntax(code);
                    break;
            }
            
            updateErrorDisplay(currentTab, result);
            return result.valid;
        }
        
        // Debounced syntax checking
        let syntaxCheckTimeout;
        function scheduleSyntaxCheck() {
            clearTimeout(syntaxCheckTimeout);
            syntaxCheckTimeout = setTimeout(checkCurrentSyntax, 500);
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tab) {
            // Save current tab state first
            currentTab = tab;
            
            // Hide all editors and clear ALL error indicators
            ['html', 'css', 'js'].forEach(t => {
                document.getElementById(`${t}-editor`).style.display = 'none';
                // Force hide all error displays
                const errorDiv = document.getElementById(`${t}-error`);
                const statusDiv = document.getElementById(`${t}-status`);
                errorDiv.className = 'error-indicator'; // Remove 'show' class
                errorDiv.textContent = ''; // Clear text
                statusDiv.className = 'syntax-status'; // Remove 'show' class
                statusDiv.textContent = ''; // Clear text
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Show selected editor and activate tab
            document.getElementById(tab + '-editor').style.display = 'block';
            event.target.classList.add('active');
            
            // Check syntax for the new tab after a brief delay to ensure UI is updated
            setTimeout(() => {
                checkCurrentSyntax();
            }, 100);
        }

        // ============================================
        // RUN CODE (Update Preview with Safety Features)
        // ============================================
        function runCode() {
            const htmlCode = document.getElementById('html-editor').value;
            const cssCode = document.getElementById('css-editor').value;
            const jsCode = document.getElementById('js-editor').value;

            // Clear console on each run
            clearConsole();

            // Add infinite loop protection to the JavaScript code
            const protectedJS = addLoopProtection(jsCode);

            // Create complete HTML document with console interception
            const output = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>${cssCode}</style>
                </head>
                <body>
                    ${htmlCode.replace(/<!DOCTYPE html>|<html.*?>|<head>.*?<\/head>|<body>|<\/body>|<\/html>/gi, '')}
                    <script>
                    // Intercept console methods to show in our console panel
                    (function() {
                        const originalLog = console.log;
                        const originalError = console.error;
                        const originalWarn = console.warn;
                        const originalInfo = console.info;
                        
                        function sendToParent(type, args) {
                            const message = Array.from(args).map(arg => {
                                if (typeof arg === 'object') {
                                    try {
                                        return JSON.stringify(arg, null, 2);
                                    } catch(e) {
                                        return String(arg);
                                    }
                                }
                                return String(arg);
                            }).join(' ');
                            
                            window.parent.postMessage({
                                type: 'console',
                                level: type,
                                message: message
                            }, '*');
                        }
                        
                        console.log = function() {
                            originalLog.apply(console, arguments);
                            sendToParent('log', arguments);
                        };
                        
                        console.error = function() {
                            originalError.apply(console, arguments);
                            sendToParent('error', arguments);
                        };
                        
                        console.warn = function() {
                            originalWarn.apply(console, arguments);
                            sendToParent('warn', arguments);
                        };
                        
                        console.info = function() {
                            originalInfo.apply(console, arguments);
                            sendToParent('info', arguments);
                        };
                    })();
                    
                    // Error handler to catch runtime errors
                    window.onerror = function(msg, url, lineNo, columnNo, error) {
                        window.parent.postMessage({
                            type: 'console',
                            level: 'error',
                            message: '‚ùå Error on line ' + lineNo + ': ' + msg
                        }, '*');
                        
                        document.body.innerHTML = '<div style="font-family: Arial; padding: 40px; max-width: 600px; margin: 0 auto;">' +
                            '<h2 style="color: #d32f2f;">‚ö†Ô∏è JavaScript Error</h2>' +
                            '<p style="color: #666; line-height: 1.6;"><strong>Error:</strong> ' + msg + '</p>' +
                            '<p style="color: #666;"><strong>Line:</strong> ' + lineNo + '</p>' +
                            '<p style="color: #888; font-size: 14px; margin-top: 20px;">Check the console below and your JavaScript tab for issues.<br><br>Common problems:<br>' +
                            '‚Ä¢ Typos in variable names<br>' +
                            '‚Ä¢ Missing quotes or brackets<br>' +
                            '‚Ä¢ Calling functions that don\\'t exist</p>' +
                            '</div>';
                        return true;
                    };
                    
                    ${protectedJS}
                    <\/script>
                </body>
                </html>
            `;

            // Update iframe with error boundary
            try {
                const iframe = document.getElementById('preview');
                iframe.srcdoc = output;
            } catch (error) {
                addConsoleEntry('error', '‚ùå Error running code: ' + error.message);
            }
        }

        // ============================================
        // CONSOLE PANEL FUNCTIONS
        // ============================================
        
        // Listen for messages from iframe (console.log outputs)
        window.addEventListener('message', function(event) {
            if (event.data.type === 'console') {
                addConsoleEntry(event.data.level, event.data.message);
            }
        });

        function addConsoleEntry(level, message) {
            const consolePanel = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = 'console-entry console-' + level;
            entry.textContent = '> ' + message;
            consolePanel.appendChild(entry);
            
            // Auto-scroll to bottom
            consolePanel.scrollTop = consolePanel.scrollHeight;
        }

        function clearConsole() {
            const consolePanel = document.getElementById('console');
            consolePanel.innerHTML = '<div class="console-entry console-info">Console cleared. Ready for new output!</div>';
        }

        // ============================================
        // PREVIEW FULLSCREEN & NEW WINDOW
        // ============================================

        let isFullscreen = false;

        function toggleFullscreen() {
            const previewPanel = document.getElementById('previewPanel');
            const fullscreenBtn = event.target;

            isFullscreen = !isFullscreen;

            if (isFullscreen) {
                previewPanel.classList.add('fullscreen');
                fullscreenBtn.classList.add('fullscreen-active');
                fullscreenBtn.innerHTML = '‚õ∂ Exit Fullscreen';
                fullscreenBtn.title = 'Exit fullscreen preview';
            } else {
                previewPanel.classList.remove('fullscreen');
                fullscreenBtn.classList.remove('fullscreen-active');
                fullscreenBtn.innerHTML = '‚õ∂ Fullscreen';
                fullscreenBtn.title = 'Toggle fullscreen preview';
            }
        }

        // Handle ESC key to exit fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        });

        function openPreviewInNewWindow() {
            const htmlCode = document.getElementById('html-editor').value;
            const cssCode = document.getElementById('css-editor').value;
            const jsCode = document.getElementById('js-editor').value;

            // Create the complete HTML document
            const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - ETHS Decision Tree</title>
    <style>${cssCode}</style>
</head>
<body>
${htmlCode}
<script>${jsCode}<\/script>
</body>
</html>`;

            // Open new window or reuse existing one
            if (!previewWindow || previewWindow.closed) {
                previewWindow = window.open('', '_blank', 'width=1024,height=768,menubar=yes,toolbar=yes,location=yes,status=yes,scrollbars=yes,resizable=yes');
            }

            if (previewWindow) {
                previewWindow.document.open();
                previewWindow.document.write(fullHTML);
                previewWindow.document.close();

                // Show notification
                const saveIndicator = document.getElementById('saveIndicator');
                if (saveIndicator) {
                    saveIndicator.textContent = '‚úì Opened in new window';
                    saveIndicator.classList.add('show');
                    setTimeout(() => {
                        saveIndicator.classList.remove('show');
                    }, 2000);
                }
            } else {
                alert('Pop-up blocked! Please allow pop-ups for this site to use the "Open in New Window" feature.');
            }
        }

        // Update external preview window if it's open
        function updatePreviewWindow() {
            if (previewWindow && !previewWindow.closed) {
                const htmlCode = document.getElementById('html-editor').value;
                const cssCode = document.getElementById('css-editor').value;
                const jsCode = document.getElementById('js-editor').value;

                const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview - ETHS Decision Tree</title>
    <style>${cssCode}</style>
</head>
<body>
${htmlCode}
<script>${jsCode}<\/script>
</body>
</html>`;

                previewWindow.document.open();
                previewWindow.document.write(fullHTML);
                previewWindow.document.close();
            }
        }

        // ============================================
        // INFINITE LOOP PROTECTION
        // ============================================
        // This prevents infinite loops from crashing the browser
        // It adds a counter to every loop and breaks if it runs too many times
        
        function addLoopProtection(code) {
            // Skip protection if code doesn't have loops
            if (!code.match(/\b(for|while)\s*\(/)) {
                return code;
            }

            // Add loop counter at the beginning
            let protectedCode = 'let __loopCounter = 0; const __maxLoops = 100000;\n';
            
            // Protect for loops: for(...) { becomes for(...) { if(++__loopCounter > __maxLoops) break;
            protectedCode += code.replace(
                /for\s*\([^)]*\)\s*{/g,
                (match) => match + '\nif(++__loopCounter > __maxLoops) { alert("‚ö†Ô∏è Loop Protection\\n\\nYour loop ran too many times (100,000+) and was stopped to prevent the browser from crashing.\\n\\nCheck your loop conditions!"); break; }\n'
            );
            
            // Protect while loops: while(...) { becomes while(...) { if(++__loopCounter > __maxLoops) break;
            protectedCode = protectedCode.replace(
                /while\s*\([^)]*\)\s*{/g,
                (match) => match + '\nif(++__loopCounter > __maxLoops) { alert("‚ö†Ô∏è Loop Protection\\n\\nYour loop ran too many times (100,000+) and was stopped to prevent the browser from crashing.\\n\\nCheck your loop conditions!"); break; }\n'
            );
            
            return protectedCode;
        }

        // ============================================
        // AUTO-SAVE FUNCTIONALITY
        // ============================================
        
        // Save code to current project
        function saveCode() {
            try {
                saveCurrentProject();
                
                // Show save indicator
                showSaveIndicator();
            } catch (e) {
                console.error('Failed to save:', e);
            }
        }

        // Load saved code from current project (already loaded at startup)
        function loadSavedCode() {
            // Projects are loaded through the project system now
            // This function kept for compatibility
        }

        // Show save indicator briefly
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================
        
        function exportCode() {
            const htmlCode = document.getElementById('html-editor').value;
            const cssCode = document.getElementById('css-editor').value;
            const jsCode = document.getElementById('js-editor').value;

            // Create base filename from project name
            const baseFilename = currentProject.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();

            // Download HTML file
            const htmlBlob = new Blob([htmlCode], { type: 'text/html' });
            downloadFile(htmlBlob, `${baseFilename}.html`);

            // Download CSS file
            const cssBlob = new Blob([cssCode], { type: 'text/css' });
            downloadFile(cssBlob, `${baseFilename}.css`);

            // Download JS file
            const jsBlob = new Blob([jsCode], { type: 'text/javascript' });
            downloadFile(jsBlob, `${baseFilename}.js`);

            // Show confirmation
            alert('‚úÖ Your project has been exported!\n\n3 files downloaded:\n‚Ä¢ ' + baseFilename + '.html\n‚Ä¢ ' + baseFilename + '.css\n‚Ä¢ ' + baseFilename + '.js\n\nYou can now:\n‚Ä¢ Share these files\n‚Ä¢ Import them back later to keep editing');
        }

        // Helper function to download a file
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // IMPORT FUNCTIONALITY
        // ============================================
        
        function importCode() {
            // Trigger the hidden file input
            document.getElementById('fileInput').click();
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Object to store the imported code
            const imported = {
                html: null,
                css: null,
                js: null,
                projectName: ''
            };

            let filesProcessed = 0;
            const totalFiles = files.length;

            // Process each file
            Array.from(files).forEach(file => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const content = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();

                    // Assign content based on file extension
                    if (extension === 'html') {
                        imported.html = content;
                        imported.projectName = file.name.replace('.html', '').replace(/-/g, ' ');
                    } else if (extension === 'css') {
                        imported.css = content;
                        if (!imported.projectName) {
                            imported.projectName = file.name.replace('.css', '').replace(/-/g, ' ');
                        }
                    } else if (extension === 'js') {
                        imported.js = content;
                        if (!imported.projectName) {
                            imported.projectName = file.name.replace('.js', '').replace(/-/g, ' ');
                        }
                    }

                    filesProcessed++;

                    // Once all files are processed, create the project
                    if (filesProcessed === totalFiles) {
                        try {
                            const id = 'project-' + Date.now();

                            currentProject = {
                                id: id,
                                name: imported.projectName || 'Imported Project',
                                html: imported.html || blankHTML,
                                css: imported.css || blankCSS,
                                js: imported.js || blankJS,
                                lastModified: new Date().toISOString()
                            };

                            // Update editors
                            document.getElementById('html-editor').value = currentProject.html;
                            document.getElementById('css-editor').value = currentProject.css;
                            document.getElementById('js-editor').value = currentProject.js;
                            document.getElementById('project-title').textContent = currentProject.name;

                            // Save project
                            saveCurrentProject();

                            // Run the code to show it
                            runCode();

                            // Broadcast to collaboration participants if in collaboration mode
                            if (isCollaborating && socket && currentRoom) {
                                socket.emit('code-change', {
                                    roomCode: currentRoom,
                                    editorType: 'html',
                                    content: currentProject.html,
                                    cursorPosition: 0
                                });
                                socket.emit('code-change', {
                                    roomCode: currentRoom,
                                    editorType: 'css',
                                    content: currentProject.css,
                                    cursorPosition: 0
                                });
                                socket.emit('code-change', {
                                    roomCode: currentRoom,
                                    editorType: 'js',
                                    content: currentProject.js,
                                    cursorPosition: 0
                                });
                            }

                            // Show success message
                            const importedFiles = [];
                            if (imported.html) importedFiles.push('HTML');
                            if (imported.css) importedFiles.push('CSS');
                            if (imported.js) importedFiles.push('JS');

                            alert('‚úÖ Files imported successfully!\n\nImported: ' + importedFiles.join(', ') + '\n\nYour code has been saved as a new project: "' + currentProject.name + '"');

                        } catch (error) {
                            alert('‚ùå Error importing files.\n\n' + error.message);
                            console.error('Import error:', error);
                        }
                    }
                };

                reader.readAsText(file);
            });

            // Reset file input so the same files can be imported again
            event.target.value = '';
        }

        // ============================================
        // RESET FUNCTIONALITY
        // ============================================
        
        function resetCode() {
            if (confirm('‚ö†Ô∏è Reset current project to blank?\n\nThis will clear all your current code.\n\nMake sure to export your work first if you want to save it!')) {
                // Reset to blank code
                document.getElementById('html-editor').value = blankHTML;
                document.getElementById('css-editor').value = blankCSS;
                document.getElementById('js-editor').value = blankJS;
                
                // Save the reset project
                saveCurrentProject();
                
                // Run the code
                runCode();
                
                alert('‚úÖ Code reset to blank template!');
            }
        }

        // ============================================
        // CLOSE INSTRUCTIONS
        // ============================================
        
        function closeInstructions() {
            document.getElementById('instructions').style.display = 'none';
            localStorage.setItem('eths-instructions-closed', 'true');
        }

        // ============================================
        // EMOJI SHORTCODES
        // ============================================
        // Type :emoji_name: to insert emoji
        
        const emojiMap = {
            // Smileys & Emotion
            'smile': 'üòä',
            'grin': 'üòÅ',
            'joy': 'üòÇ',
            'rofl': 'ü§£',
            'sob': 'üò≠',
            'heart_eyes': 'üòç',
            'kiss': 'üòò',
            'wink': 'üòâ',
            'thinking': 'ü§î',
            'neutral': 'üòê',
            'expressionless': 'üòë',
            'no_mouth': 'üò∂',
            'smirk': 'üòè',
            'unamused': 'üòí',
            'roll_eyes': 'üôÑ',
            'grimacing': 'üò¨',
            'lying': 'ü§•',
            'relieved': 'üòå',
            'pensive': 'üòî',
            'sleepy': 'üò™',
            'drool': 'ü§§',
            'sleeping': 'üò¥',
            'mask': 'üò∑',
            'sick': 'ü§í',
            'injured': 'ü§ï',
            'nauseated': 'ü§¢',
            'vomit': 'ü§Æ',
            'sneeze': 'ü§ß',
            'hot': 'ü•µ',
            'cold': 'ü•∂',
            'dizzy': 'üòµ',
            'explode': 'ü§Ø',
            'cowboy': 'ü§†',
            'party': 'ü•≥',
            'sunglasses': 'üòé',
            'nerd': 'ü§ì',
            'monocle': 'üßê',
            'confused': 'üòï',
            'worried': 'üòü',
            'slight_frown': 'üôÅ',
            'frown': '‚òπÔ∏è',
            'open_mouth': 'üòÆ',
            'hushed': 'üòØ',
            'astonished': 'üò≤',
            'flushed': 'üò≥',
            'pleading': 'ü•∫',
            'frowning': 'üò¶',
            'anguished': 'üòß',
            'fearful': 'üò®',
            'cold_sweat': 'üò∞',
            'disappointed': 'üòû',
            'sweat': 'üòì',
            'weary': 'üò©',
            'tired': 'üò´',
            'yawn': 'ü•±',
            'triumph': 'üò§',
            'rage': 'üò°',
            'angry': 'üò†',
            'cursing': 'ü§¨',
            'smiling_imp': 'üòà',
            'imp': 'üëø',
            'skull': 'üíÄ',
            'skull_crossbones': '‚ò†Ô∏è',
            
            // Hand gestures
            'clap': 'üëè',
            'pray': 'üôè',
            'thumbsup': 'üëç',
            'thumbsdown': 'üëé',
            'ok_hand': 'üëå',
            'punch': 'üëä',
            'fist': '‚úä',
            'v': '‚úåÔ∏è',
            'wave': 'üëã',
            'point_right': 'üëâ',
            'point_left': 'üëà',
            'point_up': '‚òùÔ∏è',
            'point_down': 'üëá',
            'raised_hand': '‚úã',
            'muscle': 'üí™',
            'fire': 'üî•',
            
            // Hearts
            'heart': '‚ù§Ô∏è',
            'orange_heart': 'üß°',
            'yellow_heart': 'üíõ',
            'green_heart': 'üíö',
            'blue_heart': 'üíô',
            'purple_heart': 'üíú',
            'black_heart': 'üñ§',
            'white_heart': 'ü§ç',
            'brown_heart': 'ü§é',
            'broken_heart': 'üíî',
            'heart_exclamation': '‚ù£Ô∏è',
            'two_hearts': 'üíï',
            'sparkling_heart': 'üíñ',
            'heartpulse': 'üíó',
            'heartbeat': 'üíì',
            'revolving_hearts': 'üíû',
            'cupid': 'üíò',
            
            // Symbols
            'star': '‚≠ê',
            'sparkles': '‚ú®',
            'boom': 'üí•',
            'dizzy_symbol': 'üí´',
            'sweat_drops': 'üí¶',
            'dash': 'üí®',
            'check': '‚úÖ',
            'x': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'stop_sign': 'üõë',
            'bell': 'üîî',
            'zzz': 'üí§',
            'speech_balloon': 'üí¨',
            'thought_balloon': 'üí≠',
            'eye': 'üëÅÔ∏è',
            'brain': 'üß†',
            
            // Activities
            'soccer': '‚öΩ',
            'basketball': 'üèÄ',
            'football': 'üèà',
            'baseball': '‚öæ',
            'tennis': 'üéæ',
            'volleyball': 'üèê',
            'trophy': 'üèÜ',
            'medal': 'üèÖ',
            'art': 'üé®',
            'game': 'üéÆ',
            'dice': 'üé≤',
            'music': 'üéµ',
            'guitar': 'üé∏',
            'microphone': 'üé§',
            'headphones': 'üéß',
            'book': 'üìñ',
            'books': 'üìö',
            'notebook': 'üìì',
            'pencil': '‚úèÔ∏è',
            'pen': 'üñäÔ∏è',
            
            // Food
            'pizza': 'üçï',
            'burger': 'üçî',
            'fries': 'üçü',
            'hotdog': 'üå≠',
            'taco': 'üåÆ',
            'burrito': 'üåØ',
            'apple': 'üçé',
            'banana': 'üçå',
            'watermelon': 'üçâ',
            'grapes': 'üçá',
            'strawberry': 'üçì',
            'cake': 'üç∞',
            'cookie': 'üç™',
            'chocolate': 'üç´',
            'candy': 'üç¨',
            'lollipop': 'üç≠',
            'coffee': '‚òï',
            'tea': 'üçµ',
            
            // Animals
            'dog': 'üêï',
            'cat': 'üêà',
            'mouse': 'üêÅ',
            'rabbit': 'üêá',
            'fox': 'ü¶ä',
            'bear': 'üêª',
            'panda': 'üêº',
            'koala': 'üê®',
            'tiger': 'üêØ',
            'lion': 'ü¶Å',
            'cow': 'üêÆ',
            'pig': 'üê∑',
            'frog': 'üê∏',
            'monkey': 'üêí',
            'chicken': 'üêî',
            'penguin': 'üêß',
            'bird': 'üê¶',
            'baby_chick': 'üê§',
            'unicorn': 'ü¶Ñ',
            'bee': 'üêù',
            'bug': 'üêõ',
            'butterfly': 'ü¶ã',
            'snail': 'üêå',
            'snake': 'üêç',
            'turtle': 'üê¢',
            'fish': 'üêü',
            'dolphin': 'üê¨',
            'whale': 'üêã',
            'shark': 'ü¶à',
            'octopus': 'üêô',
            
            // Nature
            'sun': '‚òÄÔ∏è',
            'moon': 'üåô',
            'star2': 'üåü',
            'cloud': '‚òÅÔ∏è',
            'rain': 'üåßÔ∏è',
            'umbrella': '‚òÇÔ∏è',
            'snowflake': '‚ùÑÔ∏è',
            'lightning': '‚ö°',
            'tornado': 'üå™Ô∏è',
            'rainbow': 'üåà',
            'ocean': 'üåä',
            'tree': 'üå≥',
            'evergreen': 'üå≤',
            'cactus': 'üåµ',
            'herb': 'üåø',
            'four_leaf_clover': 'üçÄ',
            'rose': 'üåπ',
            'tulip': 'üå∑',
            'sunflower': 'üåª',
            'blossom': 'üåº',
            'earth': 'üåé',
            'globe': 'üåç',
            
            // Travel & Places
            'car': 'üöó',
            'taxi': 'üöï',
            'bus': 'üöå',
            'train': 'üöÜ',
            'airplane': '‚úàÔ∏è',
            'rocket': 'üöÄ',
            'bike': 'üö≤',
            'scooter': 'üõ¥',
            'house': 'üè†',
            'school': 'üè´',
            'office': 'üè¢',
            'hospital': 'üè•',
            'bank': 'üè¶',
            'hotel': 'üè®',
            'castle': 'üè∞',
            'tent': '‚õ∫',
            
            // Objects
            'phone': 'üì±',
            'computer': 'üíª',
            'keyboard': '‚å®Ô∏è',
            'printer': 'üñ®Ô∏è',
            'camera': 'üì∑',
            'bulb': 'üí°',
            'battery': 'üîã',
            'electric_plug': 'üîå',
            'mag': 'üîç',
            'lock': 'üîí',
            'unlock': 'üîì',
            'key': 'üîë',
            'hammer': 'üî®',
            'wrench': 'üîß',
            'gear': '‚öôÔ∏è',
            'bomb': 'üí£',
            'scissors': '‚úÇÔ∏è',
            'paperclip': 'üìé',
            'pushpin': 'üìå',
            'alarm_clock': '‚è∞',
            'watch': '‚åö',
            'hourglass': '‚è≥',
            'calendar': 'üìÖ',
            'moneybag': 'üí∞',
            'dollar': 'üíµ',
            'gift': 'üéÅ',
            'balloon': 'üéà',
            
            // Flags (common ones)
            'flag_us': 'üá∫üá∏',
            'flag_uk': 'üá¨üáß',
            'flag_ca': 'üá®üá¶',
            'flag_mx': 'üá≤üáΩ',
            'flag_fr': 'üá´üá∑',
            'flag_de': 'üá©üá™',
            'flag_es': 'üá™üá∏',
            'flag_it': 'üáÆüáπ',
            'flag_jp': 'üáØüáµ',
            'flag_cn': 'üá®üá≥',
            'flag_kr': 'üá∞üá∑',
            'flag_in': 'üáÆüá≥',
            'flag_br': 'üáßüá∑',
            
            // Tech & Code specific
            'computer_mouse': 'üñ±Ô∏è',
            'bug': 'üêõ',
            'robot': 'ü§ñ',
            'alien': 'üëΩ',
            'space_invader': 'üëæ',
            'crystal_ball': 'üîÆ',
            'abacus': 'üßÆ',
            'floppy_disk': 'üíæ',
            'cd': 'üíø',
            'dvd': 'üìÄ',
            'vhs': 'üìº'
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Initialize project system
        const projects = getAllProjects();
        const lastProject = localStorage.getItem('eths-last-project');
        if (lastProject) {
            const project = projects.find(p => p.id === lastProject);
            if (project) {
                currentProject = project;
            }
        }
        
        // Load current project into editors
        document.getElementById('html-editor').value = currentProject.html;
        document.getElementById('css-editor').value = currentProject.css;
        document.getElementById('js-editor').value = currentProject.js;
        document.getElementById('project-title').textContent = currentProject.name;

        // Run code initially to show preview
        runCode();
        
        // Check initial syntax
        checkCurrentSyntax();
        
        // Update project list
        updateProjectList();

        // Auto-save every 3 seconds
        setInterval(saveCode, 3000);

        // Save when user types (debounced)
        let saveTimeout;
        document.querySelectorAll('.code-editor').forEach(editor => {
            editor.addEventListener('input', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveCode, 1000);
                
                // Also schedule syntax check
                scheduleSyntaxCheck();
            });
        });

        // Check if instructions should be shown
        if (localStorage.getItem('eths-instructions-closed') === 'true') {
            document.getElementById('instructions').style.display = 'none';
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        
        // Ctrl+S or Cmd+S to run code
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                runCode();
            }
        });

        // Tab key inserts spaces instead of changing focus
        document.querySelectorAll('.code-editor').forEach(editor => {
            editor.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                    return;
                }
                
                // Handle emoji autocomplete navigation
                const editorType = this.id.replace('-editor', '');
                const autocomplete = document.getElementById(`${editorType}-emoji-autocomplete`);
                
                if (autocomplete.classList.contains('show')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        moveEmojiSelection(editorType, 1);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        moveEmojiSelection(editorType, -1);
                    } else if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        selectCurrentEmoji(editorType);
                    } else if (e.key === 'Escape') {
                        hideEmojiAutocomplete(editorType);
                    }
                }
            });
            
            // Check for autocomplete patterns on keyup
            editor.addEventListener('keyup', function(e) {
                // Check for smart autocomplete triggers
                if (checkAutocompletePatterns(this, e.key)) {
                    // Pattern was triggered and replaced
                    return;
                }
            });
            
            // Emoji autocomplete on input
            editor.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const editorType = this.id.replace('-editor', '');
                
                // Check if we're typing an emoji shortcode
                const emojiMatch = textBeforeCursor.match(/:([a-z_]*)$/);
                
                if (emojiMatch) {
                    const searchTerm = emojiMatch[1];
                    
                    if (searchTerm.length === 0) {
                        // Just typed ":", show all emojis (limited to first 20)
                        showEmojiAutocomplete(editorType, '', this);
                    } else {
                        // Typing after ":", show filtered results
                        showEmojiAutocomplete(editorType, searchTerm, this);
                    }
                } else {
                    // Not typing emoji shortcode, hide autocomplete
                    hideEmojiAutocomplete(editorType);
                }
            });
            
            // Hide autocomplete when clicking outside
            editor.addEventListener('blur', function() {
                const editorType = this.id.replace('-editor', '');
                setTimeout(() => hideEmojiAutocomplete(editorType), 200);
            });
        });

        // ============================================
        // SMART AUTOCOMPLETE PATTERNS
        // ============================================
        
        const autocompletePatterns = {
            // HTML Boilerplate
            '<!DOCTYPE html>': '<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    \n</body>\n</html>',
            
            // HTML Tags (self-closing)
            '<img>': '<img src="" alt="">',
            '<input>': '<input type="text">',
            '<link>': '<link rel="stylesheet" href="">',
            '<meta>': '<meta name="" content="">',
            '<br>': '<br>',
            '<hr>': '<hr>',
            
            // HTML Tags (with closing)
            '<div>': '<div>\n    \n</div>',
            '<p>': '<p></p>',
            '<a>': '<a href=""></a>',
            '<button>': '<button></button>',
            '<h1>': '<h1></h1>',
            '<h2>': '<h2></h2>',
            '<h3>': '<h3></h3>',
            '<span>': '<span></span>',
            '<ul>': '<ul>\n    <li></li>\n</ul>',
            '<ol>': '<ol>\n    <li></li>\n</ol>',
            '<table>': '<table>\n    <tr>\n        <td></td>\n    </tr>\n</table>',
            '<form>': '<form action="" method="post">\n    \n</form>',
            '<select>': '<select>\n    <option value=""></option>\n</select>',
            '<style>': '<style>\n    \n<\/style>',
            '<script>': '<script>\n    \n<\/script>',
            
            // CSS common patterns
            '@media': '@media screen and (max-width: 768px) {\n    \n}',
            '@keyframes': '@keyframes animationName {\n    0% { }\n    100% { }\n}',
            '@import': '@import url("");',
            'flexbox': 'display: flex;\njustify-content: center;\nalign-items: center;',
            'grid': 'display: grid;\ngrid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\ngap: 20px;',
            
            // JavaScript patterns
            'function()': 'function name() {\n    \n}',
            'arrow': '() => {\n    \n}',
            'const': 'const name = ',
            'if()': 'if () {\n    \n}',
            'for()': 'for (let i = 0; i < length; i++) {\n    \n}',
            'foreach': 'array.forEach(item => {\n    \n});',
            'class': 'class ClassName {\n    constructor() {\n        \n    }\n}',
            'addEventListener': 'addEventListener("click", function(e) {\n    \n});',
            'fetch': 'fetch(url)\n    .then(response => response.json())\n    .then(data => {\n        \n    })\n    .catch(error => console.error(error));',
            'async': 'async function name() {\n    try {\n        \n    } catch (error) {\n        console.error(error);\n    }\n}',
            'tryCatch': 'try {\n    \n} catch (error) {\n    console.error(error);\n}',
        };
        
        // Check if pattern should trigger (on specific keys)
        function checkAutocompletePatterns(editor, key) {
            // Only check on closing characters
            if (!['>', ')', '}', '\n', ' '].includes(key)) {
                return false;
            }
            
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            
            // Check each pattern
            for (const [trigger, completion] of Object.entries(autocompletePatterns)) {
                if (textBeforeCursor.endsWith(trigger)) {
                    // Found a match! Replace with completion
                    const beforeTrigger = textBeforeCursor.slice(0, -trigger.length);
                    const afterCursor = editor.value.substring(cursorPos);
                    
                    editor.value = beforeTrigger + completion + afterCursor;
                    
                    // Position cursor intelligently
                    let newPos;
                    if (completion.includes('\n    \n')) {
                        // Position inside the indented area
                        const indentPos = beforeTrigger.length + completion.indexOf('\n    \n') + 5;
                        newPos = indentPos;
                    } else if (completion.includes('""')) {
                        // Position between quotes
                        newPos = beforeTrigger.length + completion.indexOf('""') + 1;
                    } else if (completion.includes('()')) {
                        // Position between parentheses
                        newPos = beforeTrigger.length + completion.indexOf('()') + 1;
                    } else {
                        // Position at end
                        newPos = beforeTrigger.length + completion.length;
                    }
                    
                    editor.selectionStart = editor.selectionEnd = newPos;
                    
                    // Trigger save
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveCode, 1000);
                    scheduleSyntaxCheck();
                    
                    return true;
                }
            }
            
            return false;
        }

        // ============================================
        // EMOJI AUTOCOMPLETE FUNCTIONS
        // ============================================
        
        let currentEmojiIndex = 0;
        let currentEmojiMatches = [];
        
        function showEmojiAutocomplete(editorType, searchTerm, editor) {
            const autocomplete = document.getElementById(`${editorType}-emoji-autocomplete`);
            
            // Filter emojis based on search term
            const matches = Object.entries(emojiMap)
                .filter(([name, emoji]) => name.includes(searchTerm.toLowerCase()))
                .slice(0, 10); // Show max 10 suggestions
            
            if (matches.length === 0) {
                hideEmojiAutocomplete(editorType);
                return;
            }
            
            currentEmojiMatches = matches;
            currentEmojiIndex = 0;
            
            // Build autocomplete HTML
            autocomplete.innerHTML = matches.map(([name, emoji], index) => `
                <div class="emoji-suggestion ${index === 0 ? 'selected' : ''}" data-index="${index}" onclick="insertEmoji('${editorType}', '${name}', '${emoji}')">
                    <span class="emoji-icon">${emoji}</span>
                    <span class="emoji-name">:${name}:</span>
                </div>
            `).join('');
            
            // Position autocomplete near cursor
            const rect = editor.getBoundingClientRect();
            const cursorPos = getCaretCoordinates(editor);
            
            autocomplete.style.left = (cursorPos.left) + 'px';
            autocomplete.style.top = (cursorPos.top + 20) + 'px';
            autocomplete.classList.add('show');
        }
        
        function hideEmojiAutocomplete(editorType) {
            const autocomplete = document.getElementById(`${editorType}-emoji-autocomplete`);
            autocomplete.classList.remove('show');
            currentEmojiMatches = [];
            currentEmojiIndex = 0;
        }
        
        function moveEmojiSelection(editorType, direction) {
            currentEmojiIndex = Math.max(0, Math.min(currentEmojiMatches.length - 1, currentEmojiIndex + direction));
            
            const autocomplete = document.getElementById(`${editorType}-emoji-autocomplete`);
            const suggestions = autocomplete.querySelectorAll('.emoji-suggestion');
            
            suggestions.forEach((sug, idx) => {
                if (idx === currentEmojiIndex) {
                    sug.classList.add('selected');
                    sug.scrollIntoView({ block: 'nearest' });
                } else {
                    sug.classList.remove('selected');
                }
            });
        }
        
        function selectCurrentEmoji(editorType) {
            if (currentEmojiMatches.length === 0) return;
            
            const [name, emoji] = currentEmojiMatches[currentEmojiIndex];
            insertEmoji(editorType, name, emoji);
        }
        
        function insertEmoji(editorType, name, emoji) {
            const editor = document.getElementById(`${editorType}-editor`);
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const textAfterCursor = editor.value.substring(cursorPos);
            
            // Find the start of the emoji shortcode
            const match = textBeforeCursor.match(/:([a-z_]*)$/);
            if (!match) return;
            
            const shortcodeStart = cursorPos - match[0].length;
            
            // Replace :shortcode with emoji
            editor.value = editor.value.substring(0, shortcodeStart) + emoji + textAfterCursor;
            
            // Set cursor after emoji
            const newPos = shortcodeStart + emoji.length;
            editor.selectionStart = editor.selectionEnd = newPos;
            
            // Hide autocomplete
            hideEmojiAutocomplete(editorType);
            
            // Trigger save and syntax check
            const saveEvent = new Event('input');
            editor.dispatchEvent(saveEvent);
            
            // Focus back on editor
            editor.focus();
        }
        
        // Get approximate caret position (simple version)
        function getCaretCoordinates(element) {
            const rect = element.getBoundingClientRect();
            // Rough estimate - position at left side of editor
            return {
                left: 10,
                top: 10
            };
        }

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            // Auto-save one last time
            saveCode();
            // Save which project was open
            localStorage.setItem('eths-last-project', currentProject.id);
        });
    </script>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js" onerror="handleSocketIOError()"></script>

    <!-- Collaboration Script -->
    <script>
        // Handle Socket.IO loading error
        function handleSocketIOError() {
            console.error('Failed to load Socket.IO - Server may not be running');
            // Show a helpful message to the user
            setTimeout(() => {
                const collabBtn = document.getElementById('collab-btn');
                if (collabBtn) {
                    collabBtn.disabled = true;
                    collabBtn.style.opacity = '0.5';
                    collabBtn.title = 'Server not running. Run "npm start" to enable collaboration.';
                    collabBtn.onclick = () => {
                        alert('‚ö†Ô∏è Collaboration Server Not Running\n\nTo use collaboration features:\n\n1. Open a terminal in the project folder\n2. Run: npm install\n3. Run: npm start\n4. Open http://localhost:3000 in your browser\n\nYou cannot use collaboration by opening index.html directly!');
                    };
                }
            }, 1000);
        }
    </script>

    <script>
        // ============================================
        // COLLABORATION SYSTEM
        // ============================================

        let socket = null;
        let currentRoom = null;
        let currentUser = null;
        let participants = new Map();
        let isCollaborating = false;
        let isReceivingUpdate = false; // Flag to prevent update loops
        let collaborationListenersAttached = false; // Prevent duplicate listeners
        let previewWindow = null; // Reference to external preview window

        // Initialize socket connection
        function initializeSocket() {
            if (socket) return;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            socket = io(window.location.origin, {
                transports: ['websocket', 'polling']
            });

            // Socket event handlers
            socket.on('connect', () => {
                console.log('Connected to collaboration server');
                updateCollaborationStatus('Connected');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateCollaborationStatus('Disconnected');
            });

            socket.on('participant-joined', (participant) => {
                participants.set(participant.id, participant);
                updateParticipantsList();
                showNotification(`${participant.name} joined the session`, 'info');
            });

            socket.on('participant-left', (data) => {
                participants.delete(data.userId);
                updateParticipantsList();
                showNotification(`${data.name} left the session`, 'info');
            });

            socket.on('code-update', (data) => {
                if (!isCollaborating) return;

                console.log('Received code update:', data.editorType, 'from user:', data.userId);

                const editor = document.getElementById(`${data.editorType}-editor`);
                if (!editor) {
                    console.error('Editor not found:', data.editorType);
                    return;
                }

                // Set flag to prevent echo
                isReceivingUpdate = true;

                // Save current cursor position for the active editor
                const isActive = document.activeElement === editor;
                const savedCursor = isActive ? editor.selectionStart : null;

                // Update the content
                editor.value = data.content;

                // Restore cursor position if this editor is active
                if (isActive && savedCursor !== null) {
                    // Try to maintain cursor position intelligently
                    const newLength = data.content.length;
                    const adjustedCursor = Math.min(savedCursor, newLength);
                    editor.selectionStart = editor.selectionEnd = adjustedCursor;
                }

                // Automatically update preview with the new code
                runCode();

                // Update external preview window if open
                updatePreviewWindow();

                // Clear flag after a brief delay
                setTimeout(() => {
                    isReceivingUpdate = false;
                }, 50);

                // Show cursor indicator for the remote user
                showRemoteCursor(data);
            });

            socket.on('cursor-update', (data) => {
                updateRemoteCursor(data);
            });

            socket.on('project-update', (data) => {
                if (!isCollaborating) return;
                // Handle project structure updates
                showNotification(`Project updated by ${participants.get(data.userId)?.name || 'someone'}`, 'info');
            });

            socket.on('new-host', (data) => {
                if (data.hostId === socket.id) {
                    showNotification('You are now the host', 'success');
                }
            });
        }

        // Create a new collaboration room
        function createCollabRoom() {
            const name = prompt('Enter your name:');
            if (!name) return;

            initializeSocket();

            const initialState = {
                js: document.getElementById('js-editor').value,
                html: document.getElementById('html-editor').value,
                css: document.getElementById('css-editor').value
            };

            socket.emit('create-room', { name, initialState }, (response) => {
                if (response.success) {
                    currentRoom = response.roomCode;
                    currentUser = response.participant;
                    isCollaborating = true;
                    participants.set(currentUser.id, currentUser);

                    showCollaborationUI();
                    showNotification(`Room created! Code: ${response.roomCode}`, 'success');

                    // Show room code prominently
                    displayRoomCode(response.roomCode);
                } else {
                    showNotification('Failed to create room', 'error');
                }
            });
        }

        // Join an existing room
        function joinCollabRoom() {
            const roomCode = prompt('Enter room code:');
            if (!roomCode) return;

            const name = prompt('Enter your name:');
            if (!name) return;

            initializeSocket();

            socket.emit('join-room', { roomCode: roomCode.toUpperCase(), name }, (response) => {
                if (response.success) {
                    currentRoom = response.roomCode;
                    currentUser = response.participant;
                    isCollaborating = true;

                    // Load room state
                    document.getElementById('js-editor').value = response.state.js || '';
                    document.getElementById('html-editor').value = response.state.html || '';
                    document.getElementById('css-editor').value = response.state.css || '';

                    // Update preview with the loaded code
                    runCode();

                    // Load participants
                    response.participants.forEach(p => participants.set(p.id, p));

                    showCollaborationUI();
                    showNotification(`Joined room: ${response.roomCode}`, 'success');
                    displayRoomCode(response.roomCode);
                } else {
                    showNotification(response.message || 'Failed to join room', 'error');
                }
            });
        }

        // Leave collaboration room
        function leaveCollabRoom() {
            if (!currentRoom) return;

            if (confirm('Are you sure you want to leave the collaboration session?')) {
                socket.emit('leave-room', currentRoom);
                isCollaborating = false;
                currentRoom = null;
                currentUser = null;
                participants.clear();
                hideCollaborationUI();
                showNotification('Left collaboration session', 'info');
            }
        }

        // Handle code changes in editors
        function handleCollabCodeChange(editorType) {
            if (!isCollaborating || !socket || isReceivingUpdate) return;

            const editor = document.getElementById(`${editorType}-editor`);
            if (!editor) return;

            const content = editor.value;
            const cursorPosition = editor.selectionStart;

            console.log('Sending code change:', editorType, 'length:', content.length);

            socket.emit('code-change', {
                roomCode: currentRoom,
                editorType,
                content,
                cursorPosition
            });
        }

        // Handle cursor movement
        function handleCursorMove(editorType, position) {
            if (!isCollaborating || !socket) return;

            socket.emit('cursor-move', {
                roomCode: currentRoom,
                editorType,
                position
            });
        }

        // Display room code prominently
        function displayRoomCode(code) {
            const codeDisplay = document.getElementById('room-code-display');
            const codeText = document.getElementById('room-code-text');
            codeText.textContent = code;
            codeDisplay.style.display = 'block';
        }

        // Show collaboration UI
        function showCollaborationUI() {
            document.getElementById('collab-panel').style.display = 'block';
            document.getElementById('collab-btn').innerHTML = 'üî¥ Leave';
            document.getElementById('collab-btn').onclick = leaveCollabRoom;
            updateParticipantsList();

            // Only attach event listeners once
            if (!collaborationListenersAttached) {
                collaborationListenersAttached = true;

                // Attach event listeners to editors
                ['js', 'html', 'css'].forEach(type => {
                    const editor = document.getElementById(`${type}-editor`);
                    if (editor) {
                        // Use named functions so we can track them
                        editor.addEventListener('input', function collabInputHandler() {
                            handleCollabCodeChange(type);
                        });
                        editor.addEventListener('click', function collabClickHandler(e) {
                            handleCursorMove(type, e.target.selectionStart);
                        });
                        editor.addEventListener('keyup', function collabKeyupHandler(e) {
                            handleCursorMove(type, e.target.selectionStart);
                        });
                        console.log('Attached collaboration listeners to', type, 'editor');
                    } else {
                        console.error('Editor not found:', type);
                    }
                });
            }
        }

        // Hide collaboration UI
        function hideCollaborationUI() {
            document.getElementById('collab-panel').style.display = 'none';
            document.getElementById('room-code-display').style.display = 'none';
            document.getElementById('collab-btn').innerHTML = 'üë• Collaborate';
            document.getElementById('collab-btn').onclick = showCollabMenu;
            collaborationListenersAttached = false;

            // Remove cursor indicators
            document.querySelectorAll('.remote-cursor').forEach(el => el.remove());
        }

        // Update participants list
        function updateParticipantsList() {
            const list = document.getElementById('participants-list');
            list.innerHTML = '';

            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div class="participant-indicator" style="background: ${participant.color}"></div>
                    <span class="participant-name">${participant.name}</span>
                    ${participant.id === currentUser?.id ? '<span class="participant-you">(You)</span>' : ''}
                `;
                list.appendChild(item);
            });
        }

        // Show remote cursor with name indicator
        function showRemoteCursor(data) {
            if (!data.cursorPosition) return;

            const participant = participants.get(data.userId);
            if (!participant) return;

            // Update participant cursor info
            participant.cursor = { editorType: data.editorType, position: data.cursorPosition };

            // Get the editor element
            const editor = document.getElementById(`${data.editorType}-editor`);
            if (!editor) return;

            // Create or update cursor indicator
            let cursorId = `cursor-${data.userId}`;
            let cursorIndicator = document.getElementById(cursorId);

            if (!cursorIndicator) {
                cursorIndicator = document.createElement('div');
                cursorIndicator.id = cursorId;
                cursorIndicator.className = 'remote-cursor';
                cursorIndicator.innerHTML = `
                    <div class="remote-cursor-label" style="background: ${participant.color}">
                        ${participant.name}
                    </div>
                `;
                editor.parentElement.appendChild(cursorIndicator);
            }

            // Position the cursor indicator (simplified - shows at top of editor with user's color)
            cursorIndicator.style.display = 'block';
            cursorIndicator.style.borderLeftColor = participant.color;

            // Hide after 3 seconds of inactivity
            clearTimeout(cursorIndicator.hideTimeout);
            cursorIndicator.hideTimeout = setTimeout(() => {
                if (cursorIndicator) {
                    cursorIndicator.style.display = 'none';
                }
            }, 3000);
        }

        // Update remote cursor display
        function updateRemoteCursor(data) {
            const participant = participants.get(data.userId);
            if (!participant) return;

            participant.cursor = { editorType: data.editorType, position: data.position };

            // Update cursor indicator
            showRemoteCursor({
                userId: data.userId,
                editorType: data.editorType,
                cursorPosition: data.position
            });
        }

        // Show collaboration menu
        function showCollabMenu() {
            const choice = confirm('Create a new room? (OK = Create, Cancel = Join)');
            if (choice) {
                createCollabRoom();
            } else {
                joinCollabRoom();
            }
        }

        // Copy room code to clipboard
        function copyRoomCode() {
            const code = document.getElementById('room-code-text').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('Room code copied to clipboard!', 'success');
            });
        }

        // Hide room code display
        function hideRoomCode() {
            document.getElementById('room-code-display').style.display = 'none';
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('collab-notification');
            notification.textContent = message;
            notification.className = `collab-notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Update collaboration status
        function updateCollaborationStatus(status) {
            const statusEl = document.getElementById('collab-status');
            if (statusEl) {
                statusEl.textContent = status;
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            // Check if there's a room code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                setTimeout(() => {
                    const name = prompt('Enter your name to join the room:');
                    if (name) {
                        initializeSocket();
                        socket.emit('join-room', { roomCode: roomCode.toUpperCase(), name }, (response) => {
                            if (response.success) {
                                currentRoom = response.roomCode;
                                currentUser = response.participant;
                                isCollaborating = true;
                                document.getElementById('js-editor').value = response.state.js || '';
                                document.getElementById('html-editor').value = response.state.html || '';
                                document.getElementById('css-editor').value = response.state.css || '';
                                response.participants.forEach(p => participants.set(p.id, p));
                                showCollaborationUI();
                                showNotification(`Joined room: ${response.roomCode}`, 'success');
                                displayRoomCode(response.roomCode);
                            }
                        });
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>
